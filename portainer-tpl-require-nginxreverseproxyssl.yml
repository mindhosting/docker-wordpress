#
#
# WARNING!!
# DO NOT EDIT THIS FILE UNLESS YOU KNOW WHAT YOU'RE DOING
# ALL NECESSARY VARIABLES ARE EDITABLE FORM PORTAINER TEMPLATE
#
#

version: '2'

volumes:
  mysql:
  web:
  duplicati:
  backups:

services:
  db:
    image: mysql:5.7.29
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: $USERNAME
      MYSQL_USER: $USERNAME
      MYSQL_PASSWORD: $PASSWORD
      MYSQL_ROOT_PASSWORD: $DB_ROOT_PASSWORD
      TZ: Africa/Tunis
    volumes:
      - mysql:/var/lib/mysql
    network_mode: bridge

  wp:
    image: mindhosting/wordpress:latest
    depends_on:
      - db
    restart: unless-stopped
    links:
      - db:db
    volumes:
      - web:/web_data/public_html
    hostname: $DOMAIN_NAME
    environment:
      FILEMANAGER_ROOT_PATH: '/web_data/public_thml'
      TZ: Africa/Tunis
      WP_URL: https://$DOMAIN_NAME/
      DB_NAME: $USERNAME
      DB_USER: $USERNAME
      DB_PASSWORD: $PASSWORD
      DB_HOST: db
      WP_TITLE: Blog
      ADMIN_USERNAME: $USERNAME
      ADMIN_PASSWORD: $PASSWORD
      WP_ADMIN_EMAIL: $EMAIL
      VIRTUAL_HOST: $DOMAIN_NAME
      LETSENCRYPT_HOST: $DOMAIN_NAME
      LETSENCRYPT_EMAIL: $LETSENCRYPT_EMAIL
    network_mode: bridge

  duplicati:
    image: linuxserver/duplicati
    restart: unless-stopped
    environment:
      PUID: 1000
      PGID: 1000
      TZ: Africa/Tunis
      CLI_ARGS: #optional
      VIRTUAL_HOST: duplicati.$DOMAIN_NAME
      LETSENCRYPT_HOST: duplicati.$DOMAIN_NAME
      LETSENCRYPT_EMAIL: $LETSENCRYPT_EMAIL
      VIRTUAL_PORT: '8200'
    volumes:
      # DUPLICATI CONFIGURATION
      - duplicati:/config
      # TO CONTROLE DOCKER SOCK AND DOCKER TO STOP/START MYSQL CONTAINER BEFORE/AFTER BACKUP
      #- /var/run/docker.sock:/var/run/docker.sock
      #- /usr/bin/docker:/usr/bin/docker
      #- ./volumes/backup/script.sh:/usr/bin/script.sh
      # ACCESS TO VOLUME SOURCES
      - mysql:/source/db_data
      - web:/source/public_html
      # BACKUP DISTINATION
      - backups:/backups
    hostname: duplicati.$DOMAIN_NAME
    network_mode: bridge

  phpmyadmin:
    image: phpmyadmin/phpmyadmin
    restart: unless-stopped
    depends_on:
      - db
    links:
      - db:db
    environment:
      MYSQL_USERNAME: root
      MYSQL_ROOT_PASSWORD: $DB_ROOT_PASSWORD
      PMA_HOST: db
      TZ: Africa/Tunis
      VIRTUAL_HOST: phpmyadmin.$DOMAIN_NAME
      LETSENCRYPT_HOST: phpmyadmin.$DOMAIN_NAME
      LETSENCRYPT_EMAIL: $LETSENCRYPT_EMAIL
    network_mode: bridge
